{"version":3,"sources":["../src/index.js"],"names":[],"mappings":"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","file":"index.js","sourceRoot":"./src/index.js","sourcesContent":["import express from 'express';\nimport basicAuth from 'node-basicauth';\nimport bodyParser from 'body-parser';\nimport cookieParser from 'cookie-parser';\nimport compression from 'compression';\nimport babelify from 'express-babelify-middleware';\nimport fs from 'fs';\nimport morgan from 'morgan';\nimport { join } from 'path';\nimport favicon from 'serve-favicon';\nimport stylus from 'stylus';\nimport nib from 'nib';\n\nimport { isArray, isObject, isFunction, isString } from 'magic-types';\nimport log from 'magic-server-log';\n\nimport appRoutes from './routes';\nimport headers from './headers';\nimport handle404 from './errors/handle404';\nimport handle500 from './errors/handle500';\n\n// import { init as initAdmin } from 'magic-admin';\n// import blog from 'magic-blog';\n// import db from 'magic-db';\n\nexport const conjure =\n  () =>\n    express();\n\nexport const Express = express;\n\nexport const Router = express.Router();\n\nexport const Magic = app => {\n  const dir = app.get('cwd') || process.cwd();\n  const css = app.get('css') || stylus;\n  // const dbSettings = app.get('dbOpts') || false;\n  const routes = app.get('router');\n  const env = app.get('env') || 'production';\n  const publicDir = app.get('publicDir') || 'public';\n  const viewDir = app.get('viewDir') || 'views';\n  const appDirs = app.get('dirs');\n  const basicAuthConfig = app.get('basicAuth');\n  const port = app.get('port') || 1337;\n  const viewEngine = app.get('view engine') || 'pug';\n  const babelifyFiles = app.get('babelifyFiles');\n  const logLevel = app.get('logLevel') || 'combined';\n\n  const dirs = {\n    root: dir,\n    public: join(dir, publicDir),\n    views: join(dir, viewDir),\n    ...appDirs,\n  };\n\n  const faviconPath = join(dirs.public, 'favicon.ico');\n\n  app.set('css', css);\n  app.set('dirs', dirs);\n\n  // set req.app to use in middleware\n  app.use(\n    (req, res, next) => {\n      req.app = app;\n      next();\n    });\n\n  // set expiry headers\n  app.use(headers);\n\n  // enable http basicAuth\n  if (basicAuthConfig) {\n    app.use(basicAuth(basicAuthConfig));\n  }\n\n  // fs.existsSync only gets called once on first request\n  if (faviconPath && !app.get('faviconChecked') && !app.get('faviconExists')) {\n    app.set('faviconChecked', true);\n    app.set('faviconExists', fs.existsSync(faviconPath));\n  }\n\n  if (app.get('faviconExists')) {\n    app.use(favicon(faviconPath));\n  }\n\n  app.set('views', dirs.views);\n  app.set('view engine', viewEngine);\n\n  app.use(compression({ threshold: 128 }));\n\n  const cssMiddleware =\n    (str, path) =>\n      css(str)\n        .set('filename', path)\n        .set('compress', env === 'production')\n        .use(nib())\n        .import('nib');\n\n  app.use(css.middleware({\n    src: dirs.public,\n    maxage: '1d',\n    compile: cssMiddleware,\n  }));\n\n  if (isString(babelifyFiles) || isArray(babelifyFiles)) {\n    [].concat(babelifyFiles).forEach(\n      f => {\n        // Precompile a browserified file at a path\n        const fileUrl = `/js/${f}.js`;\n        const bundleUrl = `${dirs.public}/js/${f}/index.js`;\n\n        app.use(fileUrl, babelify(bundleUrl));\n      }\n    );\n  }\n\n  app.use(express.static(join(__dirname, 'public'), { maxAge: '1w' }));\n\n  app.use(express.static(dirs.public, { maxAge: '1d' }));\n\n  // if (dbSettings && !app.get('db')) {\n  //   app.use(db);\n  // }\n\n  // if (app.enabled('admin')) {\n  //   app.use(initAdmin);\n  // }\n\n  /*\n   TODO: reenable\n   if (app.get('blogRoot')) {\n   let blogRoot = app.get('blogRoot');\n   if (typeof blogRoot !== 'string' && typeof blogRoot !== 'number') {\n   blogRoot = 'blog';\n   }\n   if (blogRoot.charAt(0) !== '/') {\n   blogRoot = '/' + blogRoot;\n   } else {\n   app.set('blogRoot', blogRoot.substr(1));\n   }\n   app.use(blogRoot, blog);\n   }\n   */\n\n  // logging\n  app.use(morgan(logLevel));\n\n  // if host sets bodyparser to true, init it\n  if (app.enabled('bodyParser')) {\n    app.use(bodyParser.json());\n    app.use(bodyParser.urlencoded({ extended: true }));\n  }\n\n  // if host sets cookieparser to true, init it:\n  if (app.enabled('cookieParser')) {\n    app.use(cookieParser());\n  }\n\n  // load host specific router\n  if (routes) {\n    if (isObject(routes)) {\n      Object.keys(routes).forEach(\n        key => {\n          const route = routes[key];\n          if (isFunction(route)) {\n            app.get(key, routes[key]);\n          }\n        }\n      );\n    } else if (isArray(routes)) {\n      routes.forEach(\n        route =>\n          app.use(route)\n      );\n    } else if (isFunction(routes)) {\n      app.use(routes);\n    }\n  }\n\n  // default router\n  app.use(appRoutes);\n\n  // we are in a 404 error\n  app.use(handle404);\n\n  // oops, worst case fallback, 500 server error.\n  app.use(handle500);\n\n  app.get('*', (req, res, next) => {\n    console.log('catchall');\n    res.status(200).send('yay');\n  });\n\n  app.listen(port, err => {\n    if (err) {\n      log.error(err);\n    }\n\n    log(`app listening to port ${port}`);\n  });\n\n  return app;\n};\n\nexport default Magic;\n"]}