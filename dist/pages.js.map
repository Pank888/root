{"version":3,"sources":["../src/pages.js"],"names":[],"mappings":"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","file":"pages.js","sourceRoot":"./src/index.js","sourcesContent":["import log from 'magic-server-log';\n\nconst libName = 'magic-pages';\n\nconst noop = () => {};\n\nexport const renderTemplate =\n  (res, template, next = noop) => {\n    log(`${libName}: rendering template ${template}`);\n    res.render(template, (err, html) => {\n      if (err) { log.error(`magic-view: error in res.render ${err}`); }\n      if (!html) {\n        log.error(`${libName}: html file was empty for template ${template}`);\n      }\n      if (err || !html) { return next(); } // 404, no error passing!\n      res.status(200).send(html);\n    });\n  };\n\nconst getPage =\n  (req, res) => {\n    if (res.locals.page) { return res.locals.page; }\n    return (req.params && req.params.page) ? req.params.page : 'index';\n  };\n\nconst getTemplate =\n  (req, res) => {\n    const page = getPage(req, res);\n    let template = 'pages/';\n\n    if (req.params && req.params.dir) {\n      template += req.params.dir + '/';\n    }\n\n    template += page;\n\n    log(`${libName} Rendering Page: ${page} with template ${template}`);\n    res.locals.page = page;\n    res.locals.template = template;\n    return template;\n  };\n\nconst getPageSlug =\n  req =>\n    req.params && req.params.page\n      ? req.params.page\n      : 'index';\n\nconst getPageParentSlug =\n  req =>\n    req.params && req.params.dir\n      ? req.params.dir\n      : false;\n\nexport const page =\n  (req, res, next = noop) => {\n    const template = getTemplate(req, res);\n    const db = req.app.get('db');\n\n    if (!db || !db.pages) {\n      return renderTemplate(res, template, next);\n    }\n\n    log.success('db.pages is set');\n    const parentSlug = getPageParentSlug(req);\n    const pageQuery = {\n      slug: getPageSlug(req),\n    };\n\n    if (parentSlug) {\n      pageQuery.parent = parentSlug;\n    }\n\n    db.pages.findOne(pageQuery, (err, page) => {\n      if (err) {\n        return log.error(err);\n      }\n\n      if (!page) {\n        return renderTemplate(res, template, next);\n      }\n\n      // TODO: actually render db page\n      console.log(page);\n    });\n  };\n"]}