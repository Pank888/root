{"version":3,"sources":["src/handle404.js","src/handle500.js","src/headers.js","src/index.js","src/pages.js","src/router.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import log from 'magic-server-log';\nimport { page } from './pages';\n\nconst noop = () => {};\n\nexport const handle404 =\n  (req, res, next = noop) => {\n    const app = req.app;\n    const p404 = app.get('404page') || '404';\n    const r404 = app.get('404redirect') || false;\n\n    log.warn(`404 error page called, page was: ${req.params.page}`);\n\n    if (r404) {\n      log(`magic-errorHandler r404 was set in host, redirect: ${r404}`);\n      return res.redirect(r404);\n    }\n\n    req.params.page = p404;\n    res.status(404);\n\n    page(req, res, err => {\n      if (err) {\n        log.error(`404 page template for host: ${req.hostname} not found`);\n        return next(err);\n      }\n    });\n  };\n\nexport default handle404;\n","import log from 'magic-server-log';\n\nexport const handle500 =\n  (err, req, res) => {\n    log.error(`500 called, err: ${err}`);\n    res.send('500 server error');\n  };\n\nexport default handle500;\n","const noop = () => {};\n\n// http header middleware function\nexport const headers =\n  (req, res, next = noop) => {\n    const app = req.app;\n    const env = app.get('env') || 'production';\n    const poweredBy = app.get('X-Powered-By') || 'Magic';\n    const maxAge = app.get('maxAge') || 60 * 60 * 24 * 7; // default to 7 days\n\n    if (env !== 'development') {\n      res.set('Cache-Control', `public, max-age=${maxAge}`);\n      res.set('Expires', new Date(Date.now() + (maxAge * 1000)).toUTCString());\n    }\n\n    res.set('X-Powered-By', poweredBy);\n    next();\n  };\n\nexport default headers;\n","import express from 'express';\nimport basicAuth from 'node-basicauth';\nimport bodyParser from 'body-parser';\nimport cookieParser from 'cookie-parser';\nimport compression from 'compression';\nimport { existsSync } from 'fs';\nimport { isArray, isObject } from 'magic-types';\nimport morgan from 'morgan';\nimport { join } from 'path';\nimport favicon from 'serve-favicon';\nimport stylus from 'stylus';\nimport nib from 'nib';\n\nimport router from './router';\nimport headers from './headers';\nimport handle404 from './handle404';\nimport handle500 from './handle500';\n\n// import { init as initAdmin } from 'magic-admin';\n// import blog from 'magic-blog';\n// import db from 'magic-db';\n\nexport default\n  (M, app, dir) => {\n    const css = app.get('css') || stylus;\n    const env = app.get('env') || 'production';\n    const faviconPath = join(dir, 'public', 'favicon.ico');\n    // const dbSettings = app.get('dbOpts') || false;\n\n    const dirs = {\n      root: dir,\n      public: join(dir, app.get('publicDir') || 'public'),\n      cache: join(dir, app.get('cacheDir') || '.cache'),\n      views: join(dir, app.get('viewsDir') || 'views'),\n      ...app.get('dirs'),\n    };\n\n    app.set('css', css);\n    app.set('dirs', dirs);\n\n    app.use(\n      (req, res, next) => {\n        req.app = app;\n        next();\n      });\n\n    // set expiry headers\n    app.use({\n      ...headers,\n      ...app.get('headers'),\n    });\n\n    const basicAuthConfig = app.get('basicAuth');\n    if (basicAuthConfig) {\n      app.use(basicAuth(basicAuthConfig));\n    }\n\n    // fs.existsSync only gets called once on first request\n    if (!app.get('faviconChecked') && !app.get('faviconExists')) {\n      app.set('faviconChecked', true);\n      app.set('faviconExists', existsSync(faviconPath));\n    }\n\n    if (app.get('faviconExists')) {\n      app.use(favicon(faviconPath));\n    }\n\n    app.set('views', dirs.views);\n    app.set('view engine', app.get('view engine') || 'jade');\n\n    app.use(compression({ threshold: 128 }));\n\n    const cssMiddleware =\n      (str, path) =>\n        css(str)\n          .set('filename', path)\n          .set('compress', env === 'production')\n          .use(nib())\n          .import('nib');\n\n    app.use(css.middleware({\n      src: dirs.public,\n      maxage: '1d',\n      compile: cssMiddleware,\n    }));\n\n    app.use(express.static(join(__dirname, 'public'), { maxAge: '1w' }));\n\n    app.use(express.static(dirs.public, { maxAge: '1d' }));\n\n    // if (dbSettings && !app.get('db')) {\n    //   app.use(db);\n    // }\n\n    // if (app.enabled('admin')) {\n    //   app.use(initAdmin);\n    // }\n\n    /*\n    TODO: reenable\n    if (app.get('blogRoot')) {\n      let blogRoot = app.get('blogRoot');\n      if (typeof blogRoot !== 'string' && typeof blogRoot !== 'number') {\n        blogRoot = 'blog';\n      }\n      if (blogRoot.charAt(0) !== '/') {\n        blogRoot = '/' + blogRoot;\n      } else {\n        app.set('blogRoot', blogRoot.substr(1));\n      }\n      app.use(blogRoot, blog);\n    }\n    */\n\n    const logLevel = app.get('logLevel') || 'combined';\n\n    // logging\n    app.use(morgan(logLevel));\n\n    // if host sets bodyparser to true, init it\n    if (app.enabled('bodyParser')) {\n      app.use(bodyParser.json());\n      app.use(bodyParser.urlencoded({ extended: false }));\n    }\n\n    // if host sets cookieparser to true, init it:\n    if (app.enabled('cookieParser')) {\n      app.use(cookieParser());\n    }\n\n    // load host specific router\n    if (app.get('router')) {\n      const routes = app.get('router');\n\n      if (isArray(routes) || isObject(routes)) {\n        Object.keys(routes).forEach(\n          key =>\n            app.use(routes[key])\n          );\n      } else if (typeof routes === 'function') {\n        app.use(routes);\n      }\n    }\n\n    // default router\n    app.use(router);\n\n    // we are in a 404 error\n    app.use(handle404);\n\n    // oops, worst case fallback, 500 server error.\n    app.use(handle500);\n\n    return app;\n  };\n","import log from 'magic-server-log';\n\nconst libName = 'magic-pages';\n\nconst noop = () => {};\n\nexport const renderTemplate =\n  (res, template, next = noop) => {\n    log(`${libName}: rendering template ${template}`);\n    res.render(template, (err, html) => {\n      if (err) { log.error(`magic-view: error in res.render ${err}`); }\n      if (!html) {\n        log.error(`${libName}: html file was empty for template ${template}`);\n      }\n      if (err || !html) { return next(); } // 404, no error passing!\n      res.status(200).send(html);\n    });\n  };\n\nconst getPage =\n  (req, res) => {\n    if (res.locals.page) { return res.locals.page; }\n    return (req.params && req.params.page) ? req.params.page : 'index';\n  };\n\nconst getTemplate =\n  (req, res) => {\n    const page = getPage(req, res);\n    let template = 'pages/';\n\n    if (req.params && req.params.dir) {\n      template += req.params.dir + '/';\n    }\n\n    template += page;\n\n    log(`${libName} Rendering Page: ${page} with template ${template}`);\n    res.locals.page = page;\n    res.locals.template = template;\n    return template;\n  };\n\nconst getPageSlug =\n  req =>\n    req.params && req.params.page\n      ? req.params.page\n      : 'index';\n\nconst getPageParentSlug =\n  req =>\n    req.params && req.params.dir\n      ? req.params.dir\n      : false;\n\nexport const page =\n  (req, res, next = noop) => {\n    const template = getTemplate(req, res);\n    const db = req.app.get('db');\n\n    if (!db || !db.pages) {\n      return renderTemplate(res, template, next);\n    }\n\n    log.success('db.pages is set');\n    const parentSlug = getPageParentSlug(req);\n    const pageQuery = {\n      slug: getPageSlug(req),\n    };\n\n    if (parentSlug) {\n      pageQuery.parent = parentSlug;\n    }\n\n    db.pages.findOne(pageQuery, (err, page) => {\n      if (err) {\n        return log.error(err);\n      }\n\n      if (!page) {\n        return renderTemplate(res, template, next);\n      }\n\n      // TODO: actually render db page\n      console.log(page);\n    });\n  };\n","import { Router } from 'express';\nimport { page } from './pages';\n\nconst noop = () => {};\n\nvar router = Router();\n\nrouter.get('/', (req, res, next = noop) => {\n  res.locals.page = 'index';\n  page(req, res, next);\n});\n\nrouter.get('/:page', page);\n\nexport default router;\n"]}